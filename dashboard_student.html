<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="UTF-8">
  <title>Şagird Paneli - Təhlükəsiz İmtahan</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      background: #f0fdf4;
      user-select: none;
    }

    header {
      background: #2563eb;
      color: #fff;
      padding: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    header h1 {
      margin: 0;
      font-size: 20px;
    }

    nav a {
      color: #fff;
      text-decoration: none;
      margin-left: 15px;
      font-weight: bold;
      cursor: pointer;
    }

    nav a:hover {
      text-decoration: underline;
    }

    .container {
      padding: 20px;
    }

    .test {
      background: #fff;
      padding: 15px;
      margin: 15px 0;
      border-radius: 6px;
      border: 1px solid #ccc;
      cursor: pointer;
      transition: 0.2s;
    }

    .test:hover {
      background: #e0f2fe;
    }

    button {
      background: #16a34a;
      color: #fff;
      border: none;
      padding: 10px 15px;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 10px;
      font-size: 16px;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .question {
      background: #f9f9f9;
      padding: 10px;
      margin: 8px 0;
      border-radius: 4px;
      border: 1px solid #ddd;
    }

    .question h4 {
      margin: 0 0 4px 0;
    }

    .variant {
      margin-left: 20px;
    }

    #finishExam {
      background: #dc2626;
      margin-top: 20px;
    }

    #timer {
      font-weight: bold;
      margin-bottom: 15px;
    }
  </style>
</head>
<body>

<header>
  <h1>Şagird Paneli</h1>
  <nav>
    <a id="welcomeMsg">Xoş gəldin, Şagird!</a>
    <a id="examMenu">İmtahanlar</a>
  </nav>
</header>

<div class="container" id="mainContainer">
  <p>İmtahanlar bölməsini seçin.</p>
</div>

<script>
  const student = JSON.parse(localStorage.getItem("currentStudent") || "{}");
  if (!student.name) { 
    window.location.href = "login.html"; 
  }

  // Xoş gəldin mesajı üçün düzəliş
  document.getElementById("welcomeMsg").innerText = `Xoş gəldin, ${student.name}!`;

  if (!localStorage.getItem("finishedExams")) localStorage.setItem("finishedExams", JSON.stringify({}));

  document.getElementById("examMenu").addEventListener("click", () => {
    const allTests = JSON.parse(localStorage.getItem("tests") || "[]");
    const finishedExams = JSON.parse(localStorage.getItem("finishedExams") || "{}");
    const availableTests = allTests.filter(t => t.allowedGroups.includes(student.group));
    const container = document.getElementById("mainContainer");
    container.innerHTML = "";

    if (availableTests.length === 0) {
      container.innerHTML = "<p>Hal-hazırda heç bir imtahan yoxdur.</p>";
      return;
    }

    const now = new Date().getTime();

    availableTests.forEach((t, i) => {
      const div = document.createElement("div");
      div.className = "test";

      const title = document.createElement("h3");
      title.innerText = `${i + 1}. ${t.title}`;
      div.appendChild(title);

      const joinBtn = document.createElement("button");
      const examKey = `${student.email}_${t.id}`;
      if (finishedExams[examKey]) {
        joinBtn.disabled = true;
        joinBtn.innerText = "İmtahan işlənilib";
      } else {
        joinBtn.innerText = "İmtahana daxil ol";
        const start = new Date(t.startTime).getTime();
        const end = new Date(t.endTime).getTime();

        if (now < start) {
          joinBtn.disabled = true;
          joinBtn.innerText = "İmtahan hələ başlamayıb";
        } else if (now > end) {
          joinBtn.disabled = true;
          joinBtn.innerText = "İmtahan bitib";
        }

        joinBtn.addEventListener("click", () => {
          container.innerHTML = ""; 

          const examTitle = document.createElement("h2");
          examTitle.innerText = t.title;
          container.appendChild(examTitle);

          const timerDiv = document.createElement("div");
          timerDiv.id = "timer";
          container.appendChild(timerDiv);

          function updateTimer() {
            const nowTime = new Date().getTime();
            let remaining = end - nowTime;
            if (remaining <= 0) {
              finishExam(true);
              clearInterval(timerInterval);
              return;
            }
            const minutes = Math.floor((remaining / (1000 * 60)) % 60);
            const seconds = Math.floor((remaining / 1000) % 60);
            timerDiv.innerText = `Qalan vaxt: ${minutes} dəq ${seconds} san`;
          }

          const timerInterval = setInterval(updateTimer, 1000);
          updateTimer();

          // Fullscreen
          document.documentElement.requestFullscreen();

          // Mətn seçmək və sağ klik qarşısı
          document.addEventListener('contextmenu', e => e.preventDefault());
          document.addEventListener('copy', e => e.preventDefault());
          document.addEventListener('cut', e => e.preventDefault());
          document.addEventListener('selectstart', e => e.preventDefault());

          let examEnded = false;

          function finishExam(auto = false) {
            if (examEnded) return;
            examEnded = true;
            finishedExams[examKey] = true;
            localStorage.setItem("finishedExams", JSON.stringify(finishedExams));
            clearInterval(timerInterval);
            if (auto) {
              alert("İmtahan bitdi və ya təhlükəsizlik səbəbindən dayandırıldı!");
            } else {
              alert("İmtahan bitdi!");
            }
            document.exitFullscreen();
            container.innerHTML = "<p>İmtahan bitdi. Müəllimə bildiriləcək.</p>";
          }

          // Fullscreen-dən çıxarsa dərhal bitir
          document.addEventListener('fullscreenchange', () => {
            if (!document.fullscreenElement && !examEnded) {
              finishExam(true);
            }
          });

          // Tab dəyişsə dərhal bitir
          document.addEventListener('visibilitychange', () => {
            if (document.hidden && !examEnded) {
              finishExam(true);
            }
          });

          t.questions.forEach((q, index) => {
            const qDiv = document.createElement("div");
            qDiv.className = "question";

            const qTitle = document.createElement("h4");
            qTitle.innerText = `${index + 1}. ${q.text}`;
            qDiv.appendChild(qTitle);

            if (q.type === "open") {
              const input = document.createElement("input");
              input.type = "text";
              input.placeholder = "Cavabınızı yazın";
              qDiv.appendChild(input);
            } else if (q.type === "closed") {
              q.variants.forEach((v, i) => {
                const label = document.createElement("label");
                label.className = "variant";
                label.innerHTML = `<input type="radio" name="q${index}" value="${i}"> ${v}`;
                qDiv.appendChild(label);
              });
            }

            container.appendChild(qDiv);
          });

          const finishBtn = document.createElement("button");
          finishBtn.id = "finishExam";
          finishBtn.innerText = "İmtahanı bitir";  // Burada səhv düzəldildi
          container.appendChild(finishBtn);

          finishBtn.addEventListener("click", () => {
            if (confirm("İmtahanı bitirmək istəyirsiniz?")) {
              finishExam();
            }
          });
        });
      }

      div.appendChild(joinBtn);
      container.appendChild(div);
    });
  });
</script>

</body>
</html>
