<!DOCTYPE html>
<html lang="az">
<head>
<meta charset="UTF-8">
<title>Müəllim Paneli</title>
<style>
body{font-family:sans-serif;background:#f0fdf4;margin:0;padding:20px;}
h2{text-align:center;margin-bottom:10px;}
input, select, button{padding:6px;margin:4px 0;border-radius:4px;border:1px solid #ccc;font-size:14px;}
button{background:#2563eb;color:#fff;border:none;cursor:pointer;}
#questionsContainer div{border:1px solid #ddd;padding:10px;margin:10px 0;border-radius:6px;background:#fff;}
label{display:block;margin-top:6px;}
#contestList, #cheatersContainer, #resultsContainer{margin-top:20px;}
.contestItem{background:#fff;padding:12px;margin:10px 0;border:1px solid #ccc;border-radius:6px;}
.contestItem h3{margin:0 0 6px 0;}
.actionBtns button{margin-right:6px;background:#16a34a;}
.deleteBtn{background:#dc2626 !important;}
.editBtn{background:#f59e0b !important;}
#cheaterAlert{width:20px;height:20px;border-radius:50%;background:gray;position:fixed;top:20px;right:20px;cursor:pointer;}
#cheatersPopup{display:none;position:fixed;top:50px;right:20px;background:#fff;padding:10px;border:1px solid #ccc;border-radius:6px;max-height:300px;overflow:auto;box-shadow:0 0 10px rgba(0,0,0,0.2);}
</style>
</head>
<body>

<h2>Müəllim Paneli - Contest Yarat</h2>

<label>Contest Başlığı:</label>
<input type="text" id="contestTitle" placeholder="Başlıq" required>

<label>Sualların sayı:</label>
<input type="number" id="questionCount" min="1" placeholder="Sual sayı">
<button id="generateQuestions">+</button>

<div id="questionsContainer"></div>

<label>Qruplar:</label>
<select id="groups" multiple required>
  <option>10(1,3)</option>
  <option>10(2,4)</option>
  <option>9(1,3)</option>
  <option>10S</option>
</select>

<label>Başlama vaxtı:</label>
<input type="datetime-local" id="startTime">

<label>Bitmə vaxtı:</label>
<input type="datetime-local" id="endTime">

<button id="submitContest">Contest Yarat</button>

<hr>
<h2>Yaradılan Contestlər</h2>
<div id="contestList"></div>

<div id="cheaterAlert" title="Xaric olunan şagirdlər"></div>
<div id="cheatersPopup">
    <h3>Xaric olunan şagirdlər</h3>
    <div id="cheatersContainer"></div>
</div>

<hr>
<h2>İmtahan Nəticələri</h2>
<div id="resultsContainer"></div>

<script>
// Dinamik sual yaratmaq
document.getElementById("generateQuestions").addEventListener("click", function(){
    const count = parseInt(document.getElementById("questionCount").value);
    const container = document.getElementById("questionsContainer");
    container.innerHTML = "";

    for(let i=1;i<=count;i++){
        const qDiv = document.createElement("div");

        const label = document.createElement("label");
        label.innerText = `Sual ${i}:`;
        qDiv.appendChild(label);

        const input = document.createElement("input");
        input.type="text";
        input.placeholder="Sual mətni";
        input.required = true;
        qDiv.appendChild(input);

        const typeSelect = document.createElement("select");
        typeSelect.innerHTML = `<option value="open">Açıq</option><option value="closed">Qapalı</option>`;
        qDiv.appendChild(typeSelect);

        const variantContainer = document.createElement("div");
        variantContainer.style.marginTop="6px";
        qDiv.appendChild(variantContainer);

        typeSelect.addEventListener("change", function(){
            variantContainer.innerHTML = "";

            if(this.value==="open"){
                const answerInput = document.createElement("input");
                answerInput.type="text";
                answerInput.placeholder="Düzgün cavab";
                variantContainer.appendChild(answerInput);
            } else if(this.value==="closed"){
                const varCountInput = document.createElement("input");
                varCountInput.type="number";
                varCountInput.min=1;
                varCountInput.placeholder="Variant sayı";
                variantContainer.appendChild(varCountInput);

                varCountInput.addEventListener("input", function(){
                    while(variantContainer.childNodes.length > 1){
                        variantContainer.removeChild(variantContainer.lastChild);
                    }
                    const vCount = parseInt(this.value);
                    for(let v=1; v<=vCount; v++){
                        const varInput = document.createElement("input");
                        varInput.type="text";
                        varInput.placeholder=`Variant ${v}`;
                        variantContainer.appendChild(varInput);
                    }
                    const correctInput = document.createElement("input");
                    correctInput.type="number";
                    correctInput.min=1;
                    correctInput.placeholder="Düzgün variant nömrəsi";
                    variantContainer.appendChild(correctInput);
                });
            }
        });

        container.appendChild(qDiv);
    }
});

// Contest yaratmaq
document.getElementById("submitContest").addEventListener("click", function(){
    const title = document.getElementById("contestTitle").value;
    const groupOptions = document.getElementById("groups").selectedOptions;
    const allowedGroups = [...groupOptions].map(o=>o.value);
    const startTime = document.getElementById("startTime").value;
    const endTime = document.getElementById("endTime").value;

    if(!title || allowedGroups.length===0 || !startTime || !endTime){
        alert("Başlıq, qruplar və vaxtları doldurun!");
        return;
    }

    const questionDivs = document.getElementById("questionsContainer").children;
    const questions = [];

    for(let qDiv of questionDivs){
        const text = qDiv.querySelector("input[type=text]").value;
        const type = qDiv.querySelector("select").value;
        let question = {text, type};

        const variantContainer = qDiv.querySelector("div");
        if(type==="closed"){
            const variants = [...variantContainer.querySelectorAll("input[type=text]")].map(i=>i.value);
            const correctIndex = parseInt(variantContainer.querySelector("input[type=number]").value);
            question.variants = variants;
            question.correct = correctIndex;
        } else if(type==="open"){
            const correctAnswer = variantContainer.querySelector("input[type=text]").value;
            question.correct = correctAnswer;
        }

        questions.push(question);
    }

    let tests = JSON.parse(localStorage.getItem("tests")||"[]");
    tests.push({id: Date.now(), title, allowedGroups, questions, startTime, endTime});
    localStorage.setItem("tests", JSON.stringify(tests));

    alert("Contest yaradıldı!");
    document.getElementById("contestTitle").value="";
    document.getElementById("questionCount").value="";
    document.getElementById("questionsContainer").innerHTML="";
    document.getElementById("groups").selectedIndex=-1;
    document.getElementById("startTime").value="";
    document.getElementById("endTime").value="";

    loadContests();
});

// Contestləri göstərmək
function loadContests(){
    const list = document.getElementById("contestList");
    list.innerHTML = "";
    const tests = JSON.parse(localStorage.getItem("tests")||"[]");

    if(tests.length===0){
        list.innerHTML = "<p>Heç bir contest yaradılmayıb.</p>";
        return;
    }

    tests.forEach((t)=>{
        const div = document.createElement("div");
        div.className = "contestItem";

        const title = document.createElement("h3");
        title.innerText = t.title;
        div.appendChild(title);

        const groupInfo = document.createElement("p");
        groupInfo.innerText = "Qruplar: " + t.allowedGroups.join(", ");
        div.appendChild(groupInfo);

        const timeInfo = document.createElement("p");
        timeInfo.innerText = `Başlama: ${t.startTime}, Bitmə: ${t.endTime}`;
        div.appendChild(timeInfo);

        const actionDiv = document.createElement("div");
        actionDiv.className="actionBtns";

        const editBtn = document.createElement("button");
        editBtn.className="editBtn";
        editBtn.innerText="Redaktə et";
        editBtn.onclick = ()=> editContest(t.id);
        actionDiv.appendChild(editBtn);

        const deleteBtn = document.createElement("button");
        deleteBtn.className="deleteBtn";
        deleteBtn.innerText="Sil";
        deleteBtn.onclick = ()=> deleteContest(t.id);
        actionDiv.appendChild(deleteBtn);

        div.appendChild(actionDiv);
        list.appendChild(div);
    });
}

// Contest silmək
function deleteContest(id){
    let tests = JSON.parse(localStorage.getItem("tests")||"[]");
    tests = tests.filter(t=>t.id!==id);
    localStorage.setItem("tests", JSON.stringify(tests));
    loadContests();
}

// Contest redaktə etmək
function editContest(id){
    let tests = JSON.parse(localStorage.getItem("tests")||"[]");
    let contest = tests.find(t=>t.id===id);
    if(!contest) return;

    const newTitle = prompt("Yeni başlıq:", contest.title);
    if(newTitle!==null) contest.title = newTitle;

    localStorage.setItem("tests", JSON.stringify(tests));
    loadContests();
}

// Cheater alert dairəsi
const cheaterAlert = document.getElementById("cheaterAlert");
const cheatersPopup = document.getElementById("cheatersPopup");
cheaterAlert.addEventListener("click", ()=>{
    cheatersPopup.style.display = cheatersPopup.style.display==="block" ? "none" : "block";
});

// Cheater məlumatlarını göstər
function loadCheaters(){
    const container = document.getElementById("cheatersContainer");
    container.innerHTML = "";
    const cheaters = JSON.parse(localStorage.getItem("cheatedStudents")||"[]");

    if(cheaters.length===0){
        container.innerHTML="<p>Heç bir şagird xaric olunmayıb.</p>";
        return;
    }

    const table = document.createElement("table");
    table.border="1";
    const thead = document.createElement("thead");
    thead.innerHTML="<tr><th>Ad</th><th>Soyad</th><th>Qrup</th><th>Test ID</th></tr>";
    table.appendChild(thead);

    const tbody = document.createElement("tbody");
    cheaters.forEach(c=>{
        const tr = document.createElement("tr");
        tr.innerHTML=`<td>${c.name}</td><td>${c.surname}</td><td>${c.group}</td><td>${c.testId}</td>`;
        tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    container.appendChild(table);
}

// Cheater alert update
function updateCheaterAlert(){
    const cheaters = JSON.parse(localStorage.getItem("cheatedStudents")||"[]");
    cheaterAlert.style.background = cheaters.length>0 ? "red" : "gray";
    loadCheaters();
}

// Balları göstərmək
function loadResults(){
    const container = document.getElementById("resultsContainer");
    container.innerHTML = "";
    const submissions = JSON.parse(localStorage.getItem("submissions")||"[]");
    const tests = JSON.parse(localStorage.getItem("tests")||"[]");

    if(submissions.length===0){
        container.innerHTML="<p>Hələ heç bir nəticə yoxdur.</p>";
        return;
    }

    const table = document.createElement("table");
    table.border="1";
    const thead = document.createElement("thead");
    thead.innerHTML="<tr><th>Şagird</th><th>Qrup</th><th>Test</th><th>Bal</th></tr>";
    table.appendChild(thead);

    const tbody = document.createElement("tbody");
    submissions.forEach(s=>{
        const test = tests.find(t=>t.title===s.testTitle);
        if(!test) return;
        let score = 0;
        test.questions.forEach((q,idx)=>{
            if(q.type==="open"){
                if(s.answers[`q${idx}`].trim().toLowerCase()===q.correct.trim().toLowerCase()) score+=6;
            } else if(q.type==="closed"){
                if(parseInt(s.answers[`q${idx}`])===q.correct) score+=6;
            }
        });
        const tr = document.createElement("tr");
        tr.innerHTML=`<td>${s.student}</td><td>${s.group}</td><td>${s.testTitle}</td><td>${score}</td>`;
        tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    container.appendChild(table);
}

// Polling
setInterval(()=>{
    updateCheaterAlert();
    loadResults();
},1000);

loadContests();
updateCheaterAlert();
loadResults();
</script>

</body>
</html>
